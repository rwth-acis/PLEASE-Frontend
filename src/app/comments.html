<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="app-comments">
  <style>
    textarea {
      width: 300px;
      height: 50px;
    }
  </style>
  <template>
    <div>
      <textarea id="commenttext" placeholder="What do you think?"></textarea>
      <button on-tap="postComment">+</button>
    </div>
    <template is="dom-repeat" items="[[comments]]">
      <div>
        <strong>[[item.creator]]</strong>
        <span>[[_formatdate(item.timestamp)]]</span>
        <p>
          [[item.text]]
        </p>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: 'app-comments',
      properties: {
        app: { observer: 'loadComments' },
        comments: {
          type: Array,
          value: () => []
        }
      },
      _formatdate: (timestamp) => new Date(timestamp),
      postComment: function() {
        this.authFetch(`${this.appmetadataUrl}/apps/${this.app}/comments`, {method: "POST", body: this.$.commenttext.value})
        .then(r => {if(r.status == 200) this.loadComments()})
        .catch(e => console.error(e))
      },
      loadComments: function() {
        if(this.app == -1) return
        fetch(`${this.appmetadataUrl}/apps/${this.app}/comments`)
        .then(r => r.json())
        .then(d => this.set('comments', d.sort((a,b) => b.timestamp-a.timestamp)))
        .catch(e => console.error(e))
      }
    });
  </script>
</dom-module>
