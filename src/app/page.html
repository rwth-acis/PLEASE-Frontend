<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./header.html">
<link rel="import" href="./description.html">
<link rel="import" href="./configuration.html">
<link rel="import" href="./comments.html">

<link rel="import" href="./jsoneditor/string.html">
<link rel="import" href="./jsoneditor/enum.html">
<link rel="import" href="./jsoneditor/array.html">
<link rel="import" href="./jsoneditor/object.html">

<dom-module id="app-page">
  <template>
    <app-header header=[[_header(appData,parsedDescription)]]></app-header>
    <app-description description=[[parsedDescription]] parse-description={{parseDescription}}></app-description>
    <h2>Configuration</h2>
    <!-- <jsoneditor-string json={{myjson}} schema="[[myschema]]"></jsoneditor-string> -->
    <jsoneditor-array json={{myjson}} schema="[[myschema]]"></jsoneditor-array>
    <!-- <jsoneditor-object json={{myjson}} schema="[[myschema]]"></jsoneditor-object> -->
    <app-configuration configuration=[[appData]]></app-configuration>
    <h2>Comments</h2>
    <app-comments appmetadata-url=[[appmetadataUrl]] app=[[app]] auth-fetch=[[authFetch]]></app-comments>
  </template>

  <script>
    Polymer({
      is: 'app-page',
      print_myjson: function () {
        console.log(this.myjson)
      },
      properties: {
        // myjson: {value: 'as'},
        // myschema: {value: {
        //   type: 'string',
        //   placeholder: 'yeah'
        // }},
        // myjson: {value: {a:'aa'},observer:'print_myjson',notify:true},
        // myschema: {value: {
        //   type: 'object',
        //   props: {
        //     a: {
        //       type: 'string',
        //       placeholder: 'some A'
        //     },
        //     b: {
        //       type: 'string',
        //       placeholder: 'some B'
        //     },
        //     c: {
        //       type: 'string',
        //       placeholder: 'some C'
        //     }
        //   },
        //   addProp: {
        //     name: 'version',
        //     type: 'string',
        //     placeholder: 'v1.2.0'
        //   },
        //   required: ['c']
        // }},
        myjson: {value: ['a','b'],observer:'print_myjson',notify:true},
        myschema: {value: {
          type: 'array',
          child: {
            type: 'string',
            placeholder: 'yeah'
          }
        }},
        app: {
          type: Number,
          value: -1,
          observer: 'update'
        },
        appmetadataUrl: String,
        parsedDescription: {
          computed: '_parsedDescription(appData,parseDescription)'
        }
      },
      update: function() {
        if(this.app != -1) {
          fetch(`${this.appmetadataUrl}/apps/${this.app}`)
          .then(response => response.json())
          .then(data => {
            this.set('appData', data)
          }).catch(console.error)
        }
      },
      _parsedDescription: function(appData, parseDescription) {
        if (!appData || !parseDescription) {
          return {title:'Load...',tabs:[]}
        } else {
          ast = parseDescription(appData.description)
          return {
            title: (c = ast.children.find(c => c.name == 'Title')) ? c.children[0] : 'No Title',
            tabs: ast.children.find(c => c.name == 'Tabs').children.map(c => ({
              header: (cc = c.children.find(c => c.name == 'Header')) ? cc.children[0] : '',
              blocks: c.children.filter(c => c.name == 'Block').map(c => ({
                content: c.children[0]
              }))
            }))
          }
        }
      },
      _header: function(appData, parsedDescription) {
        if (!appData || !parsedDescription) {
          return {title: 'Load...',rating: 3, platforms: []}
        } else
          return {
            title: parsedDescription.title,
            rating: appData.rating,
            platforms: appData.platforms
          }
      }
    });
  </script>
</dom-module>
