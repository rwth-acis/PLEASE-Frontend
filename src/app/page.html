<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="./header.html">
<link rel="import" href="./description.html">
<link rel="import" href="./configuration.html">
<link rel="import" href="./comments.html">
<link rel="import" href="./builds.html">
<link rel="import" href="./deployments.html">

<dom-module id="app-page">
  <template>
    <app-header header=[[_header(appData,parsedDescription)]] app=[[app]] auth-fetch=[[authFetch]] appmetadata-url=[[appmetadataUrl]]></app-header>
    <app-description description=[[parsedDescription]] parse-description={{parseDescription}}></app-description>

    <paper-tabs selected="{{selectedTab}}">
      <paper-tab>Comments</paper-tab>
      <paper-tab>Configuration</paper-tab>
      <paper-tab>Builds</paper-tab>
      <paper-tab>Deployments</paper-tab>
    </paper-tabs>
    <iron-pages selected="[[selectedTab]]">
      <app-comments appmetadata-url=[[appmetadataUrl]] app=[[app]] auth-fetch=[[authFetch]]></app-comments>
      <app-configuration configuration=[[appData]]></app-configuration>
      <app-builds app=[[app]] versions=[[appData.versions]] servicerunner-url=[[servicerunnerUrl]] auth-fetch=[[authFetch]]></app-builds>
      <app-deployments app=[[app]] versions=[[appData.versions]] servicerunner-url=[[servicerunnerUrl]] role-url=[[roleUrl]] auth-fetch=[[authFetch]]></app-builds>
    </iron-pages>
  </template>

  <script>
    Polymer({
      is: 'app-page',
      properties: {
        selectedTab: {value: 3},
        app: {
          type: Number,
          value: -1,
          observer: 'update'
        },
        appmetadataUrl: String,
        parsedDescription: {
          computed: '_parsedDescription(appData,parseDescription)'
        }
      },
      update: function() {
        if(this.app != -1) {
          fetch(`${this.appmetadataUrl}/apps/${this.app}`)
          .then(response => response.json())
          .then(data => {
            this.set('appData', data)
          }).catch(console.error)
        }
      },
      _parsedDescription: function(appData, parseDescription) {
        if (!appData || !parseDescription) {
          return {title:'Load...',tabs:[]}
        } else {
          ast = parseDescription(appData.description)
          return {
            title: (c = ast.children.find(c => c.name == 'Title')) ? c.children[0] : 'No Title',
            tabs: ast.children.find(c => c.name == 'Tabs').children.map(c => ({
              header: (cc = c.children.find(c => c.name == 'Header')) ? cc.children[0] : '',
              blocks: c.children.filter(c => c.name == 'Block').map(c => ({
                content: c.children[0]
              }))
            }))
          }
        }
      },
      _header: function(appData, parsedDescription) {
        if (!appData || !parsedDescription) {
          return {title: 'Load...',rating: 3, platforms: []}
        } else
          return {
            title: parsedDescription.title,
            rating: appData.rating,
            platforms: appData.platforms
          }
      }
    });
  </script>
</dom-module>
