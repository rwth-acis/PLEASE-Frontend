<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="./jsoneditor/object.html">
<link rel="import" href="./jsoneditor/string.html">

<dom-module id="app-deployments">
  <template>
    <select id="version" on-change="selectVersion">
      <option value="">select...</option>
      <template is="dom-repeat" items="[[_taglist(versions)]]">
        <option value="[[item]]">[[item]]</option>
      </template>
    </select>
    <h3>service</h3>
    <jsoneditor-object schema=[[service_schema]] json=[[json.service]] set-value="[[_setValue('service')]]"></jsoneditor-object>
    <button on-tap="postService">deploy service</button>
    <h3>role space</h3>
    <jsoneditor-object schema=[[space_schema]] json=[[json.role]] set-value="[[_setValue('role')]]"></jsoneditor-object>
    <button id="btnrole" disabled=[[!validSpaceLabel]] on-tap="postSpace">deploy role space</button>
    <jsoneditor-string set-value="[[_setSpaceLabel()]]"></jsoneditor-string>
    <h2>active deployments</h2>
    <ul>
      <template is="dom-repeat" items="[[deployments]]">
        <li>
          <strong>[[item]]</strong>
        </li>
      </template>
    </ul>
  </template>

  <script>
    Polymer({
      is: 'app-deployments',
      properties: {
        app: { observer: 'loadDeployments' },
        deployments: { value: [] },
        builds: {
          value: {}
        },
        json: { value: {} },
        validSpaceLabel: { value: false },
        service_schema: { value: {
          type: 'object',
          props: {
            base: {
              type: 'string',
              placeholder: 'alpine'
            },
            command: {
              type: 'string',
              placeholder: 'httpd -f'
            },
            env: {
              type: 'object',
              addProp: {
                name: 'param',
                type: 'string',
                placeholder: 'var'
              }
            }
          }
        } },
        space_schema: { value: {
          type: 'object',
          props: {
            base: {
              type: 'string',
              placeholder: 'alpine'
            },
            command: {
              type: 'string',
              placeholder: 'httpd -f'
            },
            title: {
              type: 'string',
              placeholder: 'MyApp'
            },
            widgets: {
              type: 'array',
              child: {
                type: 'string',
                placeholder: 'http://$ip4_http/80/widget1.xml'
              }
            },
            env: {
              type: 'object',
              addProp: {
                name: 'param',
                type: 'string',
                placeholder: 'var'
              }
            }
          }
        } }
      },
      selectVersion: function(e) {
        if(e.target.value == "") return
        v = this.versions[e.target.value]
        this.set('json', Object.assign(
          {},
          (((v.deploy||{}).service != null) ? {service: Object.assign({},
            v.deploy.service,
            (v.env != null) ? {env: v.env} : {}
          )} : {}),
          (((v.deploy||{}).role != null) ? {role: Object.assign({},
            v.deploy.role,
            (v.env != null) ? {env: v.env} : {}
          )} : {})
        ))
      },
      _setValue: function(key) {
        return (function(val){this.set(['json',key], val)}).bind(this)
      },
      _setSpaceLabel: function() {
        return (function(val){
          // TODO check role space already exists and syntax /[a-z0-9_-]+/

          this.set('validSpaceLabel', true)
          this.set('spaceLabel', val)
        }).bind(this)
      },
      _taglist: (versions) =>
        Object.keys(versions),
      _buildlist: (builds) =>
        [].concat(...Object.keys(builds).map((k) => Object.keys(builds[k]).map((id) => ({
          tag: k,
          buildid: parseInt(id),
          status: ((b = builds[k][id]).exitcode != null) ? `exited with ${b.exitcode} after ${b.runtime/1000}s` : `running since ${b.runtime/1000}s`
        })))).sort((a,b) => b.buildid-a.buildid),
      _formatdate: (timestamp) => {
        d = new Date(timestamp)
        return `${d.getFullYear()}-${d.getMonth()}-${d.getDay()}  ${d.getHours()}:${d.getMinutes()}`
      },
      postService: function(e) {
        reqBody = JSON.stringify(Object.assign({
            app: this.app,
            version: this.$.version.value
          }, this.json.service))

        this.authFetch(`${this.servicerunnerUrl}/deployed`, {method: "POST", body: reqBody})
        .then(r => {
          if(r.status != 201) throw "service deployment failed"
          this.loadDeployments()
        })
        .catch(e => console.error(e))
      },
      postSpace: function(e) {
        reqBody = JSON.stringify({
            app: this.app,
            version: this.$.version.value,
            base: this.json.role.base,
            command: this.json.role.command
        })
        if((this.spaceLabel||"") == "") return
        // deploy service
        this.authFetch(`${this.servicerunnerUrl}/deployed`, {method: 'POST', body: reqBody})
        .then(r => {
          if(r.status != 201) throw "service deployment failed"
          this.loadDeployments()
          return r.json()
        })
        .then(d => {
          // role
          ip4_http = `${this.servicerunnerUrl}/deployed/${d.iid}`
          ip6 = d.ip6
          // login
          return this.authFetch(`${this.roleUrl}/o/oauth2/authorizeImplicit?userinfo_endpoint=https://api.learning-layers.eu/o/oauth2/userinfo`)
          .then(r => {
            if(r.status != 200) throw "space creation failed (login failed)"
            // create space
            headers = {"Content-Type": "application/x-www-form-urlencoded"}
            body = [
              `openapp.ns.rdf=http://www.w3.org/1999/02/22-rdf-syntax-ns#`,
              `openapp.ns.rdfs=http://www.w3.org/2000/01/rdf-schema#`,
              `openapp.ns.dcterms=http://purl.org/dc/terms/`,
              `openapp.rdf.predicate=http://purl.org/role/terms/space`,
              `openapp.rdf.type=http://purl.org/role/terms/Space`,
              `openapp.rdfs.label=${this.spaceLabel}`,
            ].join('&')
            return this.authFetch(`${this.roleUrl}/spaces`, {credentials: 'include', method: 'POST', body, headers})
          }).then(r => {
            if(r.status != 200) throw "space creation failed"
            // add widgets
            if((this.json.role.widgets||[]).length == 0) return
            return Promise.all(this.json.role.widgets.map(w => {
              w = w.replace(/^$ip4_http/, ip4_http).replace(/^$ip6/, ip6)
              uri = `${this.roleUrl}/spaces/${this.spaceLabel}/:;`
              uri += ('http://www.w3.org/1999/02/22-rdf-syntax-ns#type=http://purl.org/role/terms/OpenSocialGadget;'
                  + `http://www.w3.org/2000/01/rdf-schema#seeAlso=${w};`
                  + 'predicate=http://purl.org/role/terms/tool'
                ).replace(/:/g, '%3A').replace(/\//g, '%2F').replace(/#/g, '%23')
              return this.authFetch(uri, {method: 'POST', body: '', credentials: 'include'})
              .then(r => {if(r.status != 201) throw `widget addition failed for ${w}`})
            }))
          })
        })
        .catch(e => console.error(e))
      },
      loadDeployments: function() {
        if(this.app == -1) return
        fetch(`${this.servicerunnerUrl}/deployed?app=${this.app}`)
        .then(r => r.json())
        .then(d => this.set('deployments', d[this.app] || []))
        .catch(e => console.error(e))
      }
    });
  </script>
</dom-module>
