<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../description.html">
<link rel="import" href="../configuration.html">

<dom-module id="app-create-page">
  <template>
    <style>
      textarea {
        width: 500px;
        height: 400px;
      }
    </style>
    <textarea value="{{appData.description::input}}" placeholder="omitted"></textarea>
    <h2>[[parsedDescription.title]]</h2>
    <app-description description=[[parsedDescription]] parse-description={{parseDescription}}></app-description>
    <app-configuration configuration=[[appData]]></app-configuration>
    <button disabled="[[_btn('disabled',btnState)]]" on-tap="postApp">[[_btn('text',btnState)]]</button>
  </template>

  <script>
    Polymer({
      self: 5,
      is: 'app-create-page',
      observers: ['_parseDescription(appData.description,parseDescription)'],
      _parseDescription: function(description, parseDescription) {
        if(!description || !parseDescription) return
        ast = parseDescription(description)
        return {
          title: (c = ast.children.find(c => c.name == 'Title')) ? c.children[0] : 'No Title',
          tabs: ast.children.find(c => c.name == 'Tabs').children.map(c => ({
            header: (cc = c.children.find(c => c.name == 'Header')) ? cc.children[0] : '',
            blocks: c.children.filter(c => c.name == 'Block').map(c => ({
              content: c.children[0]
            }))
          }))
        }
      },
      properties: {
        appmetadataUrl: String,
        parsedDescription: { computed: '_parseDescription(appData.description,parseDescription)' },
        appData: {
          value: {
            description: `
# This is a very nice app!

## Usage

Just use me, no limits

yeah

## Summary

What do you want to know?
`,
            autobuild: [{
              trigger: "commit",
              url: "https://github.com/adabru/PLEASE-sample1",
              change: "commit"
            }],
            versions: {
              v0: {
                env: {
                  s: "https://github.com/adabru/PLEASE-sample1",
                  s_name: "PLEASE-sample1"
                },
                build: {
                  base: "alpine_openssl",
                  full: "wget $s/archive/master.zip && unzip *.zip && mv mv \${s_name}* \${s_name}"
                },
                deploy: {
                  service: {
                    base: "build",
                    command: "httpd -f -h \${s_name}"
                  }
                }
              }
            }
          }
        },
        btnState: {
          type: String,
          value: "prepared"
        },
      },
      postApp: function(event) {
        this.set('btnState', 'sending')
        this.authFetch(`${this.appmetadataUrl}/apps`, {method: "POST", body: JSON.stringify(this.appData)})
        .then(response => response.json())
        .then(data => {
          this.set('btnState', 'prepared')
          window.location.hash=`#apps/${data.app}`
        }).catch((error) => {
          console.error(error)
          this.set('btnState', 'error')
        })
      },
      _btn: function(key) {
        switch(this.btnState) {
          case "prepared": return {disabled:false, text:"create and then edit"}[key]
          case "error": return {disabled:false, text:"retry"}[key]
          case "sending": return {disabled:true, text:"sending requestâ€¦"}[key]
          default: return {disabled:false, text:"unknown"}[key]
        }
      }
    });
  </script>
</dom-module>
