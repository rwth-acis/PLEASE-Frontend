<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="app-create-page">
  <template>
    <style>
      textarea {
        width: 500px;
        height: 400px;
      }
    </style>
    <h2>Description</h2>
    <textarea value="{{description::input}}" placeholder="omitted"></textarea>
    <h2>Versions</h2>
    <textarea value="{{sVersions::input}}" placeholder="{}"></textarea>
    <h2>Autobuild</h2>
    <textarea value="{{sAutobuild::input}}" placeholder="[]"></textarea>
    <button disabled="[[_btn('disabled',btnState)]]" on-tap="postApp">[[_btn('text',btnState)]]</button>
  </template>

  <script>
    Polymer({
      self: 5,
      is: 'app-create-page',
      properties: {
        appmetadataUrl: String,
        btnState: {
          type: String,
          value: "prepared"
        },
        description: {
          value: `
# This is a very nice app!

## Usage

Just use me, no limits
          `
        },
        sAutobuild: {
          value: `
[{
  "trigger": "commit",
  "url": "https://github.com/adabru/PLEASE-sample1",
  "change": "commit"
}]
          `
        },
        sVersions: {
          value: `
{
  "v0": {
    "env": {
      "s": "https://github.com/adabru/PLEASE-sample1",
      "s_name": "PLEASE-sample1"
    },
    "build": {
      "base": "alpine_openssl",
      "full": "wget $s/archive/master.zip && unzip *.zip && mv mv \${s_name}* \${s_name}"
    },
    "deploy": {
      "service": {
        "base": "build",
        "command": "httpd -f -h \${s_name}"
      }
    }
  }
}
          `
        }
      },
      postApp: function(event) {
        try { versions = JSON.parse(this.sVersions) }
        catch(e) { console.log(`error parsing versions: ${e.message}`); return }
        try { autobuild = JSON.parse(this.sAutobuild) }
        catch(e) { console.log(`error parsing autobuild: ${e.message}`); return }
        this.set('btnState', 'sending')
        reqBody = `{
          "description": ${JSON.stringify(this.description)},
          "autobuild": ${this.sAutobuild},
          "versions": ${this.sVersions}
        }`
        this.authFetch(`${this.appmetadataUrl}/apps`, {method: "POST", body: reqBody})
        .then(response => response.json())
        .then(data => {
          this.set('description', this.properties.description.value)
          this.set('sVersions', this.properties.sVersions.value)
          this.set('sAutobuild', this.properties.sAutobuild.value)
          this.set('btnState', 'prepared')
          window.location.hash=`#apps/${data.app}`
        }).catch((error) => {
          console.error(error)
          this.set('btnState', 'error')
        })
      },
      _btn: function(key) {
        switch(this.btnState) {
          case "prepared": return {disabled:false, text:"create and then edit"}[key]
          case "error": return {disabled:false, text:"retry"}[key]
          case "sending": return {disabled:true, text:"sending requestâ€¦"}[key]
          default: return {disabled:false, text:"unknown"}[key]
        }
      }
    });
  </script>
</dom-module>
